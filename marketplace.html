<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Marketplace - InvoiceX</title>
    <link href="https://fonts.googleapis.com/css2?family=Passion+One:wght@400;700;900&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #F5C04B;
            --primary-dark: #e6a832;
            --secondary-color: #6C63FF;
            --dark-bg: #121212;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-hover: rgba(255, 255, 255, 0.08);
            --text-color: #E0E0E0;
            --text-light: rgba(224, 224, 224, 0.7);
            --success-color: #4CAF50;
            --info-color: #2196F3;
            --warning-color: #FF9800;
            --danger-color: #f44336;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-image: url(assets/bg.webp);
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            color: var(--text-color);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            padding-top: 80px;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem 2rem;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(18, 18, 18, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(245, 192, 75, 0.1);
        }

        .header-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: auto;
            filter: drop-shadow(0 0 20px rgba(245, 192, 75, 0.3));
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .brand-name {
            font-family: 'Passion One', cursive;
            font-size: 2.3rem;
            font-weight: 700;
            color: #bababa;
            text-shadow: 0 0 30px rgba(245, 192, 75, 0.4);
            position: relative;
            display: inline-block;
        }

        .brand-name span {
            color: var(--primary-color);
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
        }

        .auth-btn {
            padding: 0.7rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .login-btn {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .login-btn:hover {
            background: rgba(245, 192, 75, 0.1);
        }

        .register-btn {
            background: var(--primary-color);
            color: var(--dark-bg);
            border: 2px solid var(--primary-color);
            font-weight: 600;
        }

        .register-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 192, 75, 0.3);
        }

        /* Marketplace Container */
        .marketplace-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .marketplace-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .marketplace-title {
            font-family: 'Passion One', cursive;
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .marketplace-subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Filters Section */
        .filters-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 192, 75, 0.15);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filters-title {
            font-family: 'Passion One', cursive;
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .filter-input, .filter-select {
            padding: 0.7rem 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-family: 'Roboto', sans-serif;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Business Pools Grid */
        .pools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .pool-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 192, 75, 0.15);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pool-card:hover {
            transform: translateY(-5px);
            border-color: rgba(245, 192, 75, 0.4);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .pool-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .pool-name {
            font-family: 'Passion One', cursive;
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-listed { background: rgba(33, 150, 243, 0.2); color: #2196F3; }
        .status-funded { background: rgba(156, 39, 176, 0.2); color: #9C27B0; }
        .status-paid { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }

        .pool-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .pool-detail {
            text-align: center;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .risk-score {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .risk-low { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .risk-medium { background: rgba(255, 152, 0, 0.2); color: #FF9800; }
        .risk-high { background: rgba(244, 67, 54, 0.2); color: #f44336; }

        .pool-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        /* ====== Updated Button & Pool Actions Styles (replace / override previous button rules) ====== */

        /* core button */
        .btn {
            padding: 0.65rem 1rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            transition: transform 180ms ease, box-shadow 180ms ease, opacity 180ms ease;
            box-shadow: 0 6px 16px rgba(0,0,0,0.35);
        }

        /* primary (invest) button */
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--dark-bg);
            border: 1px solid rgba(245,192,75,0.06);
            min-height: 44px;
            padding: 0.6rem 1.15rem;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(245,192,75,0.20);
        }

        /* secondary (disabled / neutral) */
        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            border: 1px solid rgba(255,255,255,0.06);
            min-height: 44px;
            padding: 0.55rem 0.95rem;
        }

        .btn[disabled], .btn-secondary[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* AI Analyst button - match page theme and blend with primary accent */
        .ai-analyst-btn {
            background: linear-gradient(180deg, rgba(245,192,75,0.06), rgba(108,99,255,0.03));
            color: var(--primary-color);
            border: 1px solid rgba(245,192,75,0.14);
            padding: 0.55rem 1rem;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 700;
            font-size: 0.92rem;
            min-height: 44px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.30);
            transition: transform 180ms ease, box-shadow 180ms ease, background 180ms ease, color 180ms ease;
        }

        .ai-analyst-btn i {
            font-size: 1rem;
            color: inherit;
        }

        .ai-analyst-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(245,192,75,0.12);
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--dark-bg);
        }

        .ai-analyst-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* make view/invest button consistent */
        .view-invest-btn {
            min-width: 140px;
            padding-left: 1rem;
            padding-right: 1rem;
            justify-content: center;
        }

        /* pool actions alignment and responsive wrapping */
        .pool-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .pool-actions > div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Small screens: stack action buttons neatly */
        @media (max-width: 480px) {
            .pool-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .ai-analyst-btn, .view-invest-btn, .btn {
                width: 100%;
                min-width: 0;
            }
        }

        /* Marketplace Content */
        .marketplace-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .marketplace-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .marketplace-title {
            font-family: 'Passion One', cursive;
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .marketplace-subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Filters Section */
        .filters-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 192, 75, 0.15);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filters-title {
            font-family: 'Passion One', cursive;
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .filter-input, .filter-select {
            padding: 0.7rem 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-family: 'Roboto', sans-serif;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Business Pools Grid */
        .pools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .pool-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 192, 75, 0.15);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pool-card:hover {
            transform: translateY(-5px);
            border-color: rgba(245, 192, 75, 0.4);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .pool-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .pool-name {
            font-family: 'Passion One', cursive;
            color: var(--primary-color);
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-listed { background: rgba(33, 150, 243, 0.2); color: #2196F3; }
        .status-funded { background: rgba(156, 39, 176, 0.2); color: #9C27B0; }
        .status-paid { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }

        .pool-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .pool-detail {
            text-align: center;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .risk-score {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .risk-low { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .risk-medium { background: rgba(255, 152, 0, 0.2); color: #FF9800; }
        .risk-high { background: rgba(244, 67, 54, 0.2); color: #f44336; }

        .pool-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        /* ====== Updated Button & Pool Actions Styles (replace / override previous button rules) ====== */

        /* core button */
        .btn {
            padding: 0.65rem 1rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            transition: transform 180ms ease, box-shadow 180ms ease, opacity 180ms ease;
            box-shadow: 0 6px 16px rgba(0,0,0,0.35);
        }

        /* primary (invest) button */
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--dark-bg);
            border: 1px solid rgba(245,192,75,0.06);
            min-height: 44px;
            padding: 0.6rem 1.15rem;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(245,192,75,0.20);
        }

        /* secondary (disabled / neutral) */
        .btn-secondary {
            background: transparent;
            color: var(--text-color);
            border: 1px solid rgba(255,255,255,0.06);
            min-height: 44px;
            padding: 0.55rem 0.95rem;
        }

        .btn[disabled], .btn-secondary[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* AI Analyst button - match page theme and blend with primary accent */
        .ai-analyst-btn {
            background: linear-gradient(180deg, rgba(245,192,75,0.06), rgba(108,99,255,0.03));
            color: var(--primary-color);
            border: 1px solid rgba(245,192,75,0.14);
            padding: 0.55rem 1rem;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 700;
            font-size: 0.92rem;
            min-height: 44px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.30);
            transition: transform 180ms ease, box-shadow 180ms ease, background 180ms ease, color 180ms ease;
        }

        .ai-analyst-btn i {
            font-size: 1rem;
            color: inherit;
        }

        .ai-analyst-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(245,192,75,0.12);
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--dark-bg);
        }

        .ai-analyst-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* make view/invest button consistent */
        .view-invest-btn {
            min-width: 140px;
            padding-left: 1rem;
            padding-right: 1rem;
            justify-content: center;
        }

        /* pool actions alignment and responsive wrapping */
        .pool-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .pool-actions > div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Small screens: stack action buttons neatly */
        @media (max-width: 480px) {
            .pool-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .ai-analyst-btn, .view-invest-btn, .btn {
                width: 100%;
                min-width: 0;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 2rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--dark-bg);
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            padding: 2.5rem;
            position: relative;
            transform: translateY(50px);
            opacity: 0;
            transition: all 0.4s ease;
            border: 1px solid rgba(245, 192, 75, 0.2);
            overflow-y: auto;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
            opacity: 1;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-title {
            font-family: 'Passion One', cursive;
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-section-title {
            font-family: 'Passion One', cursive;
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .business-profile {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .profile-detail {
            margin-bottom: 1rem;
        }

        .profile-label {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .profile-value {
            font-size: 1rem;
            font-weight: 500;
        }

        .investment-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .investment-detail {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .investment-value {
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .investment-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .invoice-breakdown {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
        }

        .invoice-table th, .invoice-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .invoice-table th {
            color: var(--primary-color);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .invoice-table td {
            font-size: 0.9rem;
        }

        .investment-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .form-input {
            padding: 0.7rem 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-family: 'Roboto', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--danger-color);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 192, 75, 0.15);
            border-radius: 15px;
        }

        .empty-icon {
            font-size: 4rem;
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        .empty-title {
            font-family: 'Passion One', cursive;
            font-size: 1.8rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .empty-description {
            color: var(--text-light);
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .pools-grid {
                grid-template-columns: 1fr;
            }
            
            .business-profile, .investment-details, .investment-form {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .pool-details {
                grid-template-columns: 1fr;
            }
        }

        /* AI Analyst Button Styles */
        .ai-analyst-btn {
            background: linear-gradient(135deg, #ac8100 0%, #775a02 100%);
            color: white;
            border: none;
            padding: 0.6rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .ai-analyst-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .ai-analyst-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* AI Analysis Modal Styles */
        .ai-analysis-modal .modal {
            max-width: 700px;
        }

        .analysis-score {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
        }

        .score-excellent { color: #28a745; }
        .score-good { color: #ffc107; }
        .score-poor { color: #dc3545; }

        .analysis-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .analysis-section h4 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-family: 'Passion One', cursive;
        }

        .risk-factors, .strengths {
            list-style: none;
            padding: 0;
        }

        .risk-factors li, .strengths li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .risk-factors li:before {
            content: "⚠️";
            margin-right: 0.5rem;
        }

        .strengths li:before {
            content: "✅";
            margin-right: 0.5rem;
        }

        .recommendation-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
        }

        .recommendation-strong-buy { background: rgba(40, 167, 69, 0.2); color: #28a745; }
        .recommendation-buy { background: rgba(23, 162, 184, 0.2); color: #17a2b8; }
        .recommendation-hold { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .recommendation-avoid { background: rgba(220, 53, 69, 0.2); color: #dc3545; }

        .loading-analysis {
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

/* Modern Navigation Styles */
.main-nav {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.nav-link {
    color: var(--text-color);
    text-decoration: none;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    position: relative;
}

.nav-link:hover {
    color: var(--primary-color);
    background: rgba(245, 192, 75, 0.1);
}

.nav-link::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    width: 0;
    height: 2px;
    background: var(--primary-color);
    transition: all 0.3s ease;
    transform: translateX(-50%);
}

.nav-link:hover::after {
    width: 80%;
}

.nav-divider {
    width: 1px;
    height: 24px;
    background: rgba(255, 255, 255, 0.2);
    margin: 0 0.5rem;
}

.nav-dashboard-btn {
    background: rgba(245, 192, 75, 0.1);
    border-color: rgba(245, 192, 75, 0.3);
}

.nav-dashboard-btn:hover {
    background: rgba(245, 192, 75, 0.2);
    transform: translateY(-2px);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .main-nav {
        gap: 1rem;
    }
    
    .nav-link {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
    }
    
    .nav-divider {
        display: none;
    }
}

@media (max-width: 480px) {
    .main-nav {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .header-container {
        flex-direction: column;
        gap: 1rem;
    }
}

/* Loading overlay + skeleton/fade-in for Marketplace */
.loading-overlay {
    position: fixed; 
    inset: 0; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    background: linear-gradient(180deg, rgba(18,18,18,0.86), rgba(18,18,18,0.95));
    z-index: 2200; 
    opacity: 0; 
    pointer-events: none; 
    transition: opacity 320ms ease;
}
.loading-overlay.active { 
    opacity: 1; 
    pointer-events: all; 
}
.loader-card { 
    display: flex; 
    gap: 1rem; 
    align-items: center; 
    padding: 1rem 1.25rem; 
    border-radius: 12px; 
    background: rgba(255,255,255,0.03); 
    border: 1px solid rgba(245,192,75,0.08); 
    box-shadow: 0 12px 28px rgba(0,0,0,0.6); 
}
.spinner { 
    width: 44px; 
    height: 44px; 
    border-radius: 50%; 
    border: 4px solid rgba(255,255,255,0.06); 
    border-top-color: var(--primary-color); 
    animation: spin 900ms linear infinite; 
}
@keyframes spin { 
    to { transform: rotate(360deg); } 
}

/* Chatbot Styles */
.chatbot-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 380px;
    height: 600px;
    background: var(--dark-bg);
    border: 1px solid rgba(245, 192, 75, 0.3);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    z-index: 10001; /* Higher than toggle */
    transform: translateY(100px);
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.chatbot-widget.active {
    transform: translateY(0);
    opacity: 1;
    pointer-events: all;
}

#toggleChatbot {
    pointer-events: auto !important;
    z-index: 10000 !important;
}

.chatbot-header {
    padding: 1.2rem;
    background: linear-gradient(135deg, rgba(245, 192, 75, 0.1), rgba(108, 99, 255, 0.1));
    border-bottom: 1px solid rgba(245, 192, 75, 0.2);
    border-radius: 20px 20px 0 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.chatbot-avatar {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: var(--dark-bg);
}

.chatbot-info h4 {
    margin: 0;
    color: var(--primary-color);
    font-family: 'Passion One', cursive;
}

.status-online {
    font-size: 0.8rem;
    color: #4CAF50;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.status-online::before {
    content: "";
    width: 8px;
    height: 8px;
    background: #4CAF50;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.chatbot-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.message {
    display: flex;
    gap: 0.8rem;
    max-width: 85%;
}

.bot-message {
    align-self: flex-start;
}

.user-message {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.bot-message .message-avatar {
    background: rgba(245, 192, 75, 0.2);
    color: var(--primary-color);
}

.user-message .message-avatar {
    background: rgba(245, 192, 75, 0.2);
    color: var(--primary-color);
}

.message-content {
    background: rgba(255, 255, 255, 0.05);
    padding: 1rem;
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.bot-message .message-content {
    border-bottom-left-radius: 5px;
    background: rgba(108, 99, 255, 0.1);
}

.user-message .message-content {
    border-bottom-right-radius: 5px;
    background: rgba(245, 192, 75, 0.1);
}

.chatbot-input {
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    gap: 0.5rem;
}

.chatbot-input input {
    flex: 1;
    padding: 0.8rem 1rem;
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-color);
    font-family: 'Roboto', sans-serif;
}

.send-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: var(--primary-color);
    color: var(--dark-bg);
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 5px 15px rgba(245, 192, 75, 0.4);
}

.chatbot-toggle {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border: none;
    color: var(--dark-bg);
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(245, 192, 75, 0.4);
    z-index: 10000;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chatbot-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 15px 40px rgba(245, 192, 75, 0.6);
}

.chatbot-notification {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-5px); }
    60% { transform: translateY(-3px); }
}

/* Quick actions */
.quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
}

.quick-action-btn {
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    color: var(--text-color);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    background: rgba(245, 192, 75, 0.1);
    border-color: var(--primary-color);
}

/* Typing indicator */
.typing-indicator .message-content {
    background: rgba(108, 99, 255, 0.1) !important;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--secondary-color);
    animation: typingBounce 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typingBounce {
    0%, 80%, 100% { 
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% { 
        transform: scale(1);
        opacity: 1;
    }
}
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay" aria-hidden="true">
    <div class="loader-card" role="status">
        <div class="spinner" aria-hidden="true"></div>
        <div>
            <div style="font-weight:700;color:var(--primary-color)">Invoice Marketplace</div>
            <div style="font-size:.95rem;color:var(--text-light)">Loading investment opportunities...</div>
        </div>
    </div>
</div>
    <!-- Header -->
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo-container">
                <img src="assets/3.png" alt="InvoiceX Logo" class="logo" onerror="this.style.display='none'">
                <h1 class="brand-name">Invoice<span>X</span></h1>
            </div>
            
            <nav class="main-nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="marketplace.html" class="nav-link">Marketplace</a>
                <div class="nav-divider"></div>
                <button class="auth-btn login-btn nav-dashboard-btn" id="dashboardBtn">Dashboard</button>
                <button class="auth-btn register-btn" id="logoutBtn">Logout</button>
            </nav>
        </div>
    </header>

    <!-- Marketplace Content -->
    <div class="marketplace-container">
        <div class="marketplace-header">
            <h1 class="marketplace-title">Invoice Marketplace</h1>
            <p class="marketplace-subtitle">
                Discover investment opportunities by purchasing shares in business invoice pools. 
                Diversify your portfolio with carefully vetted invoice financing opportunities.
            </p>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <h2 class="filters-title">Filter Opportunities</h2>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Risk Level</label>
                    <select class="filter-select" id="riskFilter">
                        <option value="all">All Risk Levels</option>
                        <option value="low">Low Risk</option>
                        <option value="medium">Medium Risk</option>
                        <option value="high">High Risk</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="statusFilter">
                        <option value="all">All Statuses</option>
                        <option value="listed">Listed</option>
                        <option value="funded">Funded</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Min. Investment (AED)</label>
                    <input type="number" class="filter-input" id="minInvestmentFilter" placeholder="0">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Max. Investment (AED)</label>
                    <input type="number" class="filter-input" id="maxInvestmentFilter" placeholder="100000">
                </div>
            </div>
        </div>

        <!-- Business Pools Grid -->
        <div class="pools-grid" id="businessPools">
            <!-- Business pools will be populated by JavaScript -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-search"></i>
            </div>
            <h2 class="empty-title">No Investment Opportunities Found</h2>
            <p class="empty-description">
                There are currently no business invoice pools available that match your filters. 
                Please try adjusting your filter criteria or check back later for new opportunities.
            </p>
        </div>
    </div>

    <!-- Investment Modal -->
    <div class="modal-overlay" id="investmentModal">
        <div class="modal">
            <button class="close-modal" id="closeInvestmentModal">&times;</button>
            <h2 class="modal-title" id="investmentModalTitle">Invest in Business Pool</h2>
            
            <div class="modal-section">
                <h3 class="modal-section-title">Business Profile</h3>
                <div class="business-profile" id="businessProfile">
                    <!-- Business profile details will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="modal-section">
                <h3 class="modal-section-title">Investment Details</h3>
                <div class="investment-details" id="investmentDetails">
                    <!-- Investment details will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="modal-section">
                <h3 class="modal-section-title">Invoice Breakdown</h3>
                <div class="invoice-breakdown">
                    <table class="invoice-table" id="invoiceBreakdown">
                        <thead>
                            <tr>
                                <th>Invoice ID</th>
                                <th>Buyer</th>
                                <th>Amount (AED)</th>
                                <th>Due Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Invoice breakdown will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="modal-section">
                <h3 class="modal-section-title">Investment Form</h3>
                <div class="investment-form">
                    <div class="form-group">
                        <label class="form-label" for="investmentAmount">Investment Amount (AED)</label>
                        <input type="number" id="investmentAmount" class="form-input" min="1000" step="1000">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="shareCount">Number of Shares</label>
                        <input type="number" id="shareCount" class="form-input" min="1" max="100" value="1">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancelInvestment">Cancel</button>
                    <button class="btn btn-primary" id="confirmInvestment">Buy Shares</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div class="modal-overlay ai-analysis-modal" id="aiAnalysisModal">
        <div class="modal">
            <button class="close-modal" id="closeAiAnalysisModal">&times;</button>
            <h2 class="modal-title">
                <i class="fas fa-brain"></i> AI Investment Analysis
            </h2>
            
            <div class="modal-section" id="aiAnalysisContent">
                <!-- AI analysis content will be populated here -->
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" id="closeAiAnalysisBtn">Close</button>
                <button class="btn btn-primary" id="viewInvestmentAfterAnalysis" style="display: none;">
                    View Investment
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAy3U4DYkseYNCskX1Rf20Ti6PcEcAyKW0",
            authDomain: "invoicex-d61c5.firebaseapp.com",
            databaseURL: "https://invoicex-d61c5-default-rtdb.firebaseio.com",
            projectId: "invoicex-d61c5",
            storageBucket: "invoicex-d61c5.firebasestorage.app",
            messagingSenderId: "285072402133",
            appId: "1:285072402133:web:0b778beff3bfed25c6e45c"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get references to Firebase services
        const auth = firebase.auth();
        const database = firebase.database();
    </script>
<script>
// Fixed Investment Chatbot Class
class InvestmentChatbot {
    constructor() {
        this.conversationHistory = [];
        this.isOpen = false;
        this.apiKey = null;
        this.init();
    }

    async init() {
        // Client no longer loads an API key from js/api.json.
        // All OpenAI requests are proxied through the serverless API endpoints (/api/chat and /api/analysis).
        this.apiKey = null; // keep for mock fallback behavior
        this.initializeChatbot();
        this.setupEventListeners();
        this.loadConversationHistory();
    }

    initializeChatbot() {
        const messagesContainer = document.getElementById('chatbotMessages');
        if (messagesContainer && messagesContainer.children.length <= 1) {
            this.addMessage("Hello! I'm your AI investment assistant. I can help you analyze investment opportunities, compare pools, and provide market insights. How can I assist you today?", 'bot');
        }
    }

    async sendMessage(message) {
        // Always show the user's message immediately in the UI
        this.addMessage(message, 'user');
        this.showTypingIndicator();

        // Always try to call the serverless chat endpoint. If it fails, fall back to mock.
        try {
            const response = await this.callGPTAPI(message);
            this.removeTypingIndicator();
            this.addMessage(response, 'bot');
            this.scrollToBottom();
        } catch (error) {
            console.error('Chatbot server error, falling back to mock:', error);
            try {
                await new Promise(res => setTimeout(res, 600));
                const mockResponse = this.getMockResponse(message);
                this.removeTypingIndicator();
                this.addMessage(mockResponse, 'bot');
                this.scrollToBottom();
            } catch (err) {
                this.removeTypingIndicator();
                console.error('Mock response error:', err);
            }
        }
    }

    getMockResponse(userMessage) {
        const lowerMessage = userMessage.toLowerCase();
        const pools = window.marketplace ? Array.from(window.marketplace.businessPools.values()) : [];
        
        if (pools.length === 0) {
            return "I don't see any active investment pools in the marketplace currently. Please check back later or contact support if you believe this is an error.";
        }
        
        if (lowerMessage.includes('risk') || lowerMessage.includes('safe')) {
            const lowRiskPools = pools.filter(pool => pool.riskScore < 40);
            if (lowRiskPools.length > 0) {
                let response = "Based on current InvoiceX marketplace data, here are the lowest risk pools:\n\n";
                lowRiskPools.forEach(pool => {
                    const roi = (pool.avgDiscountRate * 0.8).toFixed(1);
                    response += `• **${pool.businessName}**: Risk Score ${pool.riskScore}, ${roi}% ROI, ${pool.avgRepaymentDays} days\n`;
                });
                response += `\nThese pools offer the most stable investment opportunities with lower risk profiles.`;
                return response;
            } else {
                return "Currently, there are no low-risk pools available. The available pools have medium to high risk scores. Consider diversifying across multiple pools to manage risk.";
            }
        } else if (lowerMessage.includes('compare') || lowerMessage.includes('best')) {
            if (pools.length >= 2) {
                let response = "🔍 **InvoiceX Pool Comparison:**\n\n";
                pools.slice(0, 3).forEach(pool => {
                    const riskInfo = window.marketplace.getRiskLevel(pool.riskScore);
                    const roi = (pool.avgDiscountRate * 0.8).toFixed(1);
                    response += `• **${pool.businessName}**: ${riskInfo.label} (${pool.riskScore}), ${roi}% ROI, ${pool.avgRepaymentDays} days, ${pool.availableShares} shares available\n`;
                });
                return response;
            } else {
                return `Currently, there's only one pool available: **${pools[0].businessName}** with ${pools[0].availableShares} shares at AED ${pools[0].sharePrice} each.`;
            }
        } else if (lowerMessage.includes('roi') || lowerMessage.includes('return')) {
            const avgROI = pools.reduce((sum, pool) => sum + (pool.avgDiscountRate * 0.8), 0) / pools.length;
            const maxROI = Math.max(...pools.map(pool => pool.avgDiscountRate * 0.8));
            const minROI = Math.min(...pools.map(pool => pool.avgDiscountRate * 0.8));
            
            return `📈 **InvoiceX ROI Analysis:**\n\n• Average ROI across all pools: ${avgROI.toFixed(1)}%\n• Highest ROI: ${maxROI.toFixed(1)}%\n• Lowest ROI: ${minROI.toFixed(1)}%\n• Available Pools: ${pools.length}\n\nROI is calculated based on invoice discount rates and varies by pool risk profile.`;
        } else if (lowerMessage.includes('trend') || lowerMessage.includes('market')) {
            return "🌐 **InvoiceX Market Insights:**\n\n• All investment opportunities are invoice-based pools\n• Each pool contains verified business invoices\n• Risk scores are calculated based on invoice quality and business history\n• Investments are secured by actual accounts receivable\n• Recommended: Review pool details and use AI analysis for deeper insights";
        } else {
            return "I'm your InvoiceX AI assistant! I can help you analyze our current investment opportunities. Based on our platform data, I can provide insights on:\n\n• Risk assessment of available pools\n• ROI comparisons between different opportunities\n• Pool availability and share pricing\n• Investment recommendations based on your preferences\n\nWhat would you like to know about our current investment pools?";
        }
    }

    async callGPTAPI(userMessage) {
        const marketplaceContext = this.getMarketplaceContext();

        try {
            const resp = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMessage, context: marketplaceContext })
            });

            if (!resp.ok) {
                const txt = await resp.text();
                throw new Error(`Server API error ${resp.status}: ${txt}`);
            }

            const data = await resp.json();
            const botResponse = data.reply || data?.choices?.[0]?.message?.content || '';

            this.conversationHistory.push({ role: 'user', content: userMessage });
            this.conversationHistory.push({ role: 'assistant', content: botResponse });
            if (this.conversationHistory.length > 16) this.conversationHistory.splice(0, this.conversationHistory.length - 16);
            this.saveConversationHistory();

            return botResponse;
        } catch (err) {
            console.error('Error calling server chat endpoint:', err);
            return this.getMockResponse(userMessage);
        }
    }

    getMarketplaceContext() {
        if (!window.marketplace || !window.marketplace.businessPools) {
            return "No marketplace data available yet. The system is still loading investment opportunities.";
        }
        
        const pools = Array.from(window.marketplace.businessPools.values());
        if (pools.length === 0) {
            return "No investment pools are currently available in the marketplace.";
        }
        
        // Build detailed context from actual Firebase data
        let context = `Current InvoiceX Marketplace Status:\n\n`;
        context += `Total Available Pools: ${pools.length}\n\n`;
        
        pools.forEach((pool, index) => {
            const riskInfo = window.marketplace.getRiskLevel(pool.riskScore);
            context += `Pool ${index + 1}: ${pool.businessName}\n`;
            context += `  - Company: ${pool.companyName}\n`;
            context += `  - Total Value: AED ${pool.totalInvoiceValue.toLocaleString()}\n`;
            context += `  - Available Shares: ${pool.availableShares}\n`;
            context += `  - Share Price: AED ${pool.sharePrice}\n`;
            context += `  - Risk Level: ${riskInfo.label} (${pool.riskScore}/100)\n`;
            context += `  - Expected ROI: ${(pool.avgDiscountRate * 0.8).toFixed(1)}%\n`;
            context += `  - Status: ${pool.status}\n\n`;
        });
        
        // Add user context if available
        if (window.marketplace.currentUserUid) {
            context += `\nCurrent User: Logged in investor with access to all pools.`;
        }
        
        return context;
    }

    addMessage(content, sender) {
        const messagesContainer = document.getElementById('chatbotMessages');
        if (!messagesContainer) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        const avatarIcon = sender === 'bot' ? 'fas fa-robot' : 'fas fa-user';
        
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="${avatarIcon}"></i>
            </div>
            <div class="message-content">
                ${content.replace(/\n/g, '<br>')}
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
    }

    showTypingIndicator() {
        const messagesContainer = document.getElementById('chatbotMessages');
        if (!messagesContainer) return;
        
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot-message typing-indicator';
        typingDiv.id = 'typingIndicator';
        
        typingDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(typingDiv);
        this.scrollToBottom();
    }

    removeTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    scrollToBottom() {
        const messagesContainer = document.getElementById('chatbotMessages');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    setupEventListeners() {
        // Send message on button click
        const sendBtn = document.getElementById('sendMessage');
        if (sendBtn) {
            sendBtn.addEventListener('click', () => {
                this.handleSendMessage();
            });
        }

        // Send message on Enter key (use keydown for reliable Enter capture)
        const chatInput = document.getElementById('chatbotInput');
        if (chatInput) {
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.handleSendMessage();
                }
            });
        }

        // Toggle chatbot
        const toggleBtn = document.getElementById('toggleChatbot');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                this.toggleChatbot();
            });
        }

        // Close chatbot
        const closeBtn = document.getElementById('closeChatbot');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.closeChatbot();
            });
        }

        // Quick actions
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('quick-action-btn')) {
                const action = e.target.getAttribute('data-action');
                this.handleQuickAction(action);
            }
        });
    }

    handleSendMessage() {
        const input = document.getElementById('chatbotInput');
        if (!input) return;
        
        const message = input.value.trim();
        if (message) {
            this.sendMessage(message);
            input.value = '';
        }
    }

    handleQuickAction(action) {
        const actions = {
            'analyze-risk': "Can you analyze the risk factors for today's available investment pools and recommend the safest options?",
            'compare-pools': "Compare the top 3 investment pools available today in terms of ROI, risk, and repayment period.",
            'roi-calc': "Help me calculate potential ROI for different investment amounts across various risk levels.",
            'trends': "What are the current trends in invoice financing? Any particular industries performing well?"
        };
        
        if (actions[action]) {
            this.sendMessage(actions[action]);
        }
    }

    toggleChatbot() {
        const chatbot = document.getElementById('investmentChatbot');
        if (!chatbot) return;
        
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            chatbot.classList.add('active');
            const chatInput = document.getElementById('chatbotInput');
            if (chatInput) chatInput.focus();
            this.hideNotification();
        } else {
            chatbot.classList.remove('active');
        }
    }

    closeChatbot() {
        const chatbot = document.getElementById('investmentChatbot');
        if (chatbot) {
            chatbot.classList.remove('active');
            this.isOpen = false;
        }
    }

    showNotification() {
        const notification = document.getElementById('chatbotNotification');
        if (notification) {
            notification.style.display = 'flex';
        }
    }

    hideNotification() {
        const notification = document.getElementById('chatbotNotification');
        if (notification) {
            notification.style.display = 'none';
        }
    }

    saveConversationHistory() {
        try {
            localStorage.setItem('chatbot_conversation', JSON.stringify(this.conversationHistory));
        } catch (e) {
            console.warn('Could not save conversation history:', e);
        }
    }

    loadConversationHistory() {
        try {
            const saved = localStorage.getItem('chatbot_conversation');
            const messagesContainer = document.getElementById('chatbotMessages');
            
            if (!messagesContainer) return;
            
            // Clear existing messages
            messagesContainer.innerHTML = '';
            
            if (saved) {
                this.conversationHistory = JSON.parse(saved);
                
                // Only add welcome message if no conversation history exists
                if (this.conversationHistory.length === 0) {
                    this.addMessage("Hello! I'm your AI investment assistant. I can help you analyze investment opportunities, compare pools, and provide market insights. How can I assist you today?", 'bot');
                } else {
                    // Replay the conversation history
                    this.conversationHistory.forEach(msg => {
                        if (msg.role === 'user') {
                            this.addMessage(msg.content, 'user');
                        } else if (msg.role === 'assistant') {
                            this.addMessage(msg.content, 'bot');
                        }
                    });
                }
            } else {
                // No saved history, add welcome message
                this.addMessage("Hello! I'm your AI investment assistant. I can help you analyze investment opportunities, compare pools, and provide market insights. How can I assist you today?", 'bot');
            }
        } catch (e) {
            console.warn('Could not load conversation history:', e);
            // Ensure welcome message is shown even if there's an error
            const messagesContainer = document.getElementById('chatbotMessages');
            if (messagesContainer && messagesContainer.children.length === 0) {
                this.addMessage("Hello! I'm your AI investment assistant. I can help you analyze investment opportunities, compare pools, and provide market insights. How can I assist you today?", 'bot');
            }
        }
    }
}

// Initialize chatbot when DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing chatbot...');
    
    // Wait a bit for everything to settle
    setTimeout(() => {
        try {
            window.investmentChatbot = new InvestmentChatbot();
            console.log('Investment chatbot initialized successfully');
        } catch (error) {
            console.error('Failed to initialize chatbot:', error);
        }
    }, 1000);
});
</script>

<script>
    // Loading helpers
    function showLoading(msg){
        const overlay = document.getElementById('loadingOverlay');
        if(overlay){
            if(msg) overlay.querySelector('.loader-card div:last-child').lastChild.textContent = msg;
            overlay.classList.add('active');
        }
    }
    function hideLoading(){ 
        const overlay = document.getElementById('loadingOverlay'); 
        if(overlay) overlay.classList.remove('active'); 
    }

    // Show loader immediately
    showLoading('Initializing marketplace...');
</script>


    <script>
        // Marketplace JavaScript Logic
        class InvoiceMarketplace {
            constructor() {
                this.businessPools = new Map();
                this.currentUserUid = null;
                this.selectedPool = null;
                this.currentUserUid = this.getCurrentUserUid();
                this.init();
            }

            init() {
                this.initializeEventListeners();
                this.loadMarketplace();
                this.setupRealtimeListeners();
                this.setupInvestmentListeners(); // Add this line
            }

            getCurrentUserUid() {
                const user = auth.currentUser;
                if (user) {
                    return user.uid;
                }
                
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    return JSON.parse(storedUser).uid;
                }
                
                // If no user found, redirect to login
                alert('Please login first');
                window.location.href = 'index.html';
                return null;
            }



            async analyzeWithAI(poolKey) {
                const pool = this.businessPools.get(poolKey);
                if (!pool) return;

                // Show loading state
                this.showAIAnalysisLoading(pool);

                    try {
                        // Prepare analysis data
                        const analysisData = {
                            pool: {
                                businessName: pool.businessName,
                                companyName: pool.companyName,
                                totalInvoiceValue: pool.totalInvoiceValue,
                                avgDiscountRate: pool.avgDiscountRate,
                                riskScore: pool.riskScore,
                                avgRepaymentDays: pool.avgRepaymentDays,
                                availableShares: pool.availableShares,
                                sharePrice: pool.sharePrice,
                                status: pool.status
                            },
                            business: {
                                industry: pool.sellerUser.industry,
                                businessType: pool.sellerUser.businessType,
                                monthlyInvoicing: pool.sellerUser.monthlyInvoicing,
                                yearsInBusiness: pool.sellerUser.yearsInBusiness,
                                verificationLevel: pool.sellerUser.verificationLevel
                            },
                            invoices: pool.invoices.map(inv => ({
                                amount: inv.amount,
                                buyerName: inv.buyerName,
                                dueDate: inv.dueDate,
                                status: inv.status
                            })),
                            investorProfile: await this.getInvestorProfile()
                        };

                        // Call serverless analysis endpoint
                        const resp = await fetch('/api/analysis', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ analysisData })
                        });

                        if (!resp.ok) {
                            const txt = await resp.text();
                            throw new Error(`Analysis service error ${resp.status}: ${txt}`);
                        }

                        const result = await resp.json();
                        if (result.analysis) {
                            this.displayAIAnalysis(result.analysis, pool);
                        } else if (result.raw) {
                            // Server couldn't parse JSON from model
                            this.showAIAnalysisError('AI returned invalid JSON: ' + (result.raw || ''));
                        } else if (result.error) {
                            this.showAIAnalysisError(result.error);
                        } else {
                            this.showAIAnalysisError('Unknown analysis error');
                        }

                    } catch (error) {
                        console.error('AI Analysis error:', error);
                        this.showAIAnalysisError(error.message || error);
                    }
            }

            async getInvestorProfile() {
                const userSnapshot = await database.ref('users/' + this.currentUserUid).once('value');
                const userData = userSnapshot.val();
                return {
                    riskLevel: userData.riskLevel || 'medium',
                    investmentRange: userData.investmentRange || '10000-50000'
                };
            }

            async callOpenAI(/*apiKey,*/ analysisData) {
                // Proxy analysis request through server-side endpoint to keep API key secret
                try {
                    const resp = await fetch('/api/analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ analysisData })
                    });

                    if (!resp.ok) {
                        const txt = await resp.text();
                        throw new Error(`Analysis service error ${resp.status}: ${txt}`);
                    }

                    const result = await resp.json();
                    if (result.analysis) return result.analysis;
                    if (result.raw) throw new Error('AI returned unparsable JSON: ' + result.raw);
                    if (result.error) throw new Error(result.error);
                    throw new Error('Unknown analysis error');
                } catch (err) {
                    console.error('callOpenAI error:', err);
                    throw err;
                }
            }

            createAnalysisPrompt(analysisData) {
                return `Analyze this invoice financing investment opportunity and return a JSON response with this exact structure:

            {
                "score": 8,
                "recommendation": "Strong Buy",
                "riskFactors": ["Factor 1", "Factor 2", "Factor 3"],
                "strengths": ["Strength 1", "Strength 2"],
                "marketInsights": "Brief market analysis",
                "detailedAnalysis": "Comprehensive professional analysis"
            }

            Investment Data:
            - Pool: ${analysisData.pool.businessName}
            - Company: ${analysisData.pool.companyName}
            - Total Invoice Value: AED ${analysisData.pool.totalInvoiceValue}
            - Discount Rate: ${analysisData.pool.avgDiscountRate}%
            - Risk Score: ${analysisData.pool.riskScore}/100
            - Repayment Period: ${analysisData.pool.avgRepaymentDays} days
            - Available Shares: ${analysisData.pool.availableShares}
            - Share Price: AED ${analysisData.pool.sharePrice}

            Business Profile:
            - Industry: ${analysisData.business.industry}
            - Business Type: ${analysisData.business.businessType}
            - Monthly Invoicing: AED ${analysisData.business.monthlyInvoicing}
            - Years in Business: ${analysisData.business.yearsInBusiness}
            - Verification: ${analysisData.business.verificationLevel}

            Invoice Details:
            ${analysisData.invoices.map(inv => `- ${inv.buyerName}: AED ${inv.amount}, Due: ${inv.dueDate}`).join('\n')}

            Investor Profile:
            - Risk Level: ${analysisData.investorProfile.riskLevel}
            - Investment Range: ${analysisData.investorProfile.investmentRange}

            Provide professional financial analysis.`;
            }

            showAIAnalysisLoading(pool) {
                document.getElementById('aiAnalysisContent').innerHTML = `
                    <div class="loading-analysis">
                        <div class="loading-spinner"></div>
                        <h3>AI Analysis in Progress</h3>
                        <p>Analyzing ${pool.businessName}...</p>
                        <p style="font-size: 0.9rem; color: var(--text-light);">
                            Evaluating risk factors, market trends, and investment potential
                        </p>
                    </div>
                `;
                document.getElementById('aiAnalysisModal').classList.add('active');
            }

            displayAIAnalysis(analysis, pool) {
                // Validate analysis data
                if (!analysis || typeof analysis !== 'object') {
                    this.showAIAnalysisError('Invalid analysis data received');
                    return;
                }

                // Set default values if missing
                const safeAnalysis = {
                    score: analysis.score || 5,
                    recommendation: analysis.recommendation || 'Hold',
                    riskFactors: analysis.riskFactors || ['No risk factors analyzed'],
                    strengths: analysis.strengths || ['No strengths analyzed'],
                    marketInsights: analysis.marketInsights || 'No market insights available',
                    detailedAnalysis: analysis.detailedAnalysis || 'No detailed analysis available'
                };

                const scoreClass = safeAnalysis.score >= 8 ? 'score-excellent' : 
                                safeAnalysis.score >= 5 ? 'score-good' : 'score-poor';
                
                const recommendationClass = `recommendation-badge recommendation-${safeAnalysis.recommendation.toLowerCase().replace(' ', '-')}`;

                document.getElementById('aiAnalysisContent').innerHTML = `
                    <div class="analysis-section">
                        <div class="analysis-score ${scoreClass}">${safeAnalysis.score}/10</div>
                        <div class="${recommendationClass}">${safeAnalysis.recommendation}</div>
                    </div>

                    <div class="analysis-section">
                        <h4>📊 Investment Analysis</h4>
                        <p>${safeAnalysis.detailedAnalysis}</p>
                    </div>

                    <div class="analysis-section">
                        <h4>⚠️ Top Risk Factors</h4>
                        <ul class="risk-factors">
                            ${safeAnalysis.riskFactors.map(factor => `<li>${factor}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="analysis-section">
                        <h4>✅ Key Strengths</h4>
                        <ul class="strengths">
                            ${safeAnalysis.strengths.map(strength => `<li>${strength}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="analysis-section">
                        <h4>🌐 Market Insights</h4>
                        <p>${safeAnalysis.marketInsights}</p>
                    </div>
                `;

                // Show view investment button
                document.getElementById('viewInvestmentAfterAnalysis').style.display = 'inline-block';
                document.getElementById('viewInvestmentAfterAnalysis').onclick = () => {
                    this.hideAiAnalysisModal();
                    this.showInvestmentModal(pool.sellerUid + '_' + pool.poolId);
                };
            }

showAIAnalysisError(error) {
    document.getElementById('aiAnalysisContent').innerHTML = `
        <div class="analysis-section" style="border-left-color: var(--danger-color);">
            <h4>❌ Analysis Failed</h4>
            <p>Unable to generate AI analysis: ${error}</p>
            <p style="font-size: 0.9rem; color: var(--text-light);">
                Please check your API configuration or try again later.
            </p>
        </div>
    `;
}

hideAiAnalysisModal() {
    document.getElementById('aiAnalysisModal').classList.remove('active');
}

        async loadMarketplace() {
            try {
                showLoading('Loading marketplace data...');
                
                const uid = this.getCurrentUserUid();
                if (!uid) return;
                
                this.currentUserUid = uid;

                // Check if user is investor
                const userSnapshot = await database.ref('users/' + uid).once('value');
                const userData = userSnapshot.val();
                
                if (!userData || userData.userType !== 'investor') {
                    this.showToast('Investment marketplace is only available for investors', 'info');
                }

                showLoading('Processing investment opportunities...');
                
                // Load all data in parallel
                const [invoices, pools, users] = await Promise.all([
                    this.fetchAllInvoices(),
                    this.fetchAllPools(),
                    this.fetchAllUsers()
                ]);

                this.processBusinessPools(invoices, pools, users);
                this.renderBusinessPools();

                // Hide loading after a short delay to ensure smooth transition
                setTimeout(hideLoading, 500);
                
            } catch (error) {
                console.error('Error loading marketplace:', error);
                this.showToast('Error loading marketplace data: ' + error.message, 'error');
                hideLoading();
            }
        }

            async fetchAllInvoices() {
                return new Promise((resolve) => {
                    database.ref('invoices').once('value', (snapshot) => {
                        const invoices = [];
                        snapshot.forEach((childSnapshot) => {
                            invoices.push({ id: childSnapshot.key, ...childSnapshot.val() });
                        });
                        resolve(invoices);
                    });
                });
            }

            async fetchAllPools() {
                return new Promise((resolve) => {
                    database.ref('pools').once('value', (snapshot) => {
                        const pools = [];
                        snapshot.forEach((childSnapshot) => {
                            pools.push({ id: childSnapshot.key, ...childSnapshot.val() });
                        });
                        resolve(pools);
                    });
                });
            }

            async fetchAllUsers() {
                return new Promise((resolve) => {
                    database.ref('users').once('value', (snapshot) => {
                        const users = [];
                        snapshot.forEach((childSnapshot) => {
                            users.push({ id: childSnapshot.key, ...childSnapshot.val() });
                        });
                        resolve(users);
                    });
                });
            }

            processBusinessPools(invoices, pools, users) {
                this.businessPools.clear();

                // Process each pool individually instead of grouping by seller
                pools.forEach(pool => {
                    const sellerUser = users.find(user => user.id === pool.sellerUid);
                    
                    if (!sellerUser || !pool.invoiceIds) return;

                    // Get invoices for this specific pool
                    const poolInvoices = [];
                    let totalInvoiceValue = 0;
                    
                    Object.keys(pool.invoiceIds).forEach(invoiceId => {
                        const invoice = invoices.find(inv => inv.id === invoiceId);
                        if (invoice) {
                            poolInvoices.push(invoice);
                            totalInvoiceValue += invoice.amount;
                        }
                    });

                    if (poolInvoices.length === 0) return;

                    // Calculate pool-specific metrics
                    const avgDiscountRate = pool.discountPercent || 15;
                    
                    // Calculate average repayment duration for this pool
                    const now = new Date();
                    const avgRepaymentDays = poolInvoices.reduce((sum, invoice) => {
                        const dueDate = new Date(invoice.dueDate);
                        const daysUntilDue = Math.max(0, Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24)));
                        return sum + daysUntilDue;
                    }, 0) / poolInvoices.length;
                    
                    // Generate AI Risk Score for this pool
                    const riskScore = this.calculateRiskScore(poolInvoices, sellerUser);
                    
                    // Calculate available shares for this specific pool
                    // Consistent share/price calculation:
                    // - define a SHARE_UNIT (base unit, AED 1000)
                    // - totalShares = floor(advanceAmount / SHARE_UNIT)
                    // - sharePrice = round(advanceAmount / totalShares) so the full advance amount is distributed across shares
                    // - fundedShares = floor(fundedAmount / sharePrice)
                    // - availableShares = totalShares - fundedShares
                    const advanceAmount = pool.advanceAmount || (totalInvoiceValue * (1 - (pool.discountPercent || 15) / 100));
                    const SHARE_UNIT = 1000;

                    // Ensure we have at least 1 share even for small amounts
                    const totalShares = Math.max(1, Math.ceil(advanceAmount / SHARE_UNIT));
                    const sharePrice = Math.ceil(advanceAmount / totalShares); // Use ceil to ensure full coverage
                    const fundedShares = Math.floor((pool.fundedAmount || 0) / sharePrice);
                    const availableShares = Math.max(0, totalShares - fundedShares);

                    // Use pool's actual status
                    const status = pool.status || 'listed';
                    
                    // Use pool name or business name + pool ID
                    const displayName = pool.name || `${sellerUser.businessName || sellerUser.fullName} - Pool ${pool.id.slice(-4)}`;
                    
                    // Create unique key for each pool (sellerUid + poolId)
                    const poolKey = `${pool.sellerUid}_${pool.id}`;
                    
                    this.businessPools.set(poolKey, {
                        poolId: pool.id,
                        sellerUid: pool.sellerUid,
                        businessName: displayName, // Use pool-specific name
                        companyName: sellerUser.businessName || sellerUser.fullName, // Keep original company name
                        totalInvoiceValue,
                        avgDiscountRate,
                        riskScore,
                        avgRepaymentDays: Math.round(avgRepaymentDays),
                        availableShares: availableShares,
                        fundedAmount: pool.fundedAmount || 0,
                        totalShares: totalShares,
                        sharePrice: sharePrice,
                        status,
                        sellerUser,
                        invoices: poolInvoices,
                        poolData: pool // Store the actual pool data
                    });
                });
            }

            calculateRiskScore(invoices, sellerUser) {
                // Simplified risk scoring algorithm
                let score = 50; // Base score
                
                // Factor 1: If we have a small number of invoices in the pool, adjust risk
                if (invoices.length < 2) {
                    // Fewer invoices in pool = higher risk
                    score -= 10;
                }
                
                // Factor 2: Invoice amounts (higher amounts = higher risk)
                const avgInvoiceAmount = invoices.reduce((sum, invoice) => sum + invoice.amount, 0) / invoices.length;
                if (avgInvoiceAmount > 50000) score -= 10;
                else if (avgInvoiceAmount < 10000) score += 5;
                
                // Factor 3: Number of invoices (more invoices = diversification = lower risk)
                if (invoices.length > 5) score += 10;
                else if (invoices.length < 2) score -= 5;
                
                // Factor 4: Business type (from user data)
                if (sellerUser.businessType === 'LLC') score += 5;
                if (sellerUser.industry === 'Technology') score += 5;
                
                // Factor 5: Monthly invoicing (higher = more stable)
                if (sellerUser.monthlyInvoicing > 50000) score += 10;
                
                // Ensure score is between 0 and 100
                score = Math.max(0, Math.min(100, score));
                
                return score;
            }

            getRiskLevel(score) {
                if (score >= 70) return { level: 'low', label: 'Low Risk' };
                if (score >= 40) return { level: 'medium', label: 'Medium Risk' };
                return { level: 'high', label: 'High Risk' };
            }

            renderBusinessPools() {
                const container = document.getElementById('businessPools');
                const emptyState = document.getElementById('emptyState');
                
                // Apply filters - we need to get both key and value for filtering
                const filteredPools = Array.from(this.businessPools.entries()).filter(([poolKey, pool]) => {
                    return this.applyFilters([pool]).length > 0;
                });
                
                if (filteredPools.length === 0) {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }
                
                container.style.display = 'grid';
                emptyState.style.display = 'none';
                container.innerHTML = '';
                
                filteredPools.forEach(([poolKey, pool]) => {
                    const riskInfo = this.getRiskLevel(pool.riskScore);
                    const poolCard = document.createElement('div');
                    poolCard.className = 'pool-card';

                    // Determine invest button HTML based on pool availability/status
                    const canInvest = (pool.availableShares && pool.availableShares > 0) && pool.status !== 'fully_funded';
                    const investButtonHtml = canInvest
                        ? `<button class="btn btn-primary view-invest-btn" data-pool-key="${poolKey}">View / Invest</button>`
                        : `<button class="btn btn-secondary" disabled title="${pool.status === 'fully_funded' || (pool.availableShares === 0) ? 'This pool is fully funded' : 'No shares available'}">Fully Funded</button>`;

                    const aiAnalystButton = `<button class="ai-analyst-btn" data-pool-key="${poolKey}">
                        <i class="fas fa-brain"></i> AI Analyst
                    </button>`;

                    poolCard.innerHTML = `
                        <div class="pool-header">
                            <div>
                                <div class="pool-name">${pool.businessName}</div>
                                <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 0.2rem;">
                                    by ${pool.companyName}
                                </div>
                                <span class="risk-score risk-${riskInfo.level}">
                                    <i class="fas fa-${riskInfo.level === 'low' ? 'shield-alt' : riskInfo.level === 'medium' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                                    ${riskInfo.label}
                                </span>
                            </div>
                            <span class="status-badge status-${pool.status}">${pool.status}</span>
                        </div>
                        <div class="pool-details">
                            <div class="pool-detail">
                                <div class="detail-value">AED ${pool.totalInvoiceValue.toLocaleString()}</div>
                                <div class="detail-label">Total Invoice Value</div>
                            </div>
                            <div class="pool-detail">
                                <div class="detail-value">${pool.avgDiscountRate.toFixed(1)}%</div>
                                <div class="detail-label">Avg. Discount Rate</div>
                            </div>
                            <div class="pool-detail">
                                <div class="detail-value">${pool.avgRepaymentDays} days</div>
                                <div class="detail-label">Repayment Duration</div>
                            </div>
                            <div class="pool-detail">
                                <div class="detail-value">${pool.availableShares}</div>
                                <div class="detail-label">Available Shares</div>
                            </div>
                        </div>
                        <div class="pool-actions">
                            <div>
                                <span style="font-size: 0.9rem; color: var(--text-light);">
                                    Risk Score: <strong>${pool.riskScore}/100</strong>
                                </span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                ${aiAnalystButton}
                                ${investButtonHtml}
                            </div>
                        </div>
                    `;
                    container.appendChild(poolCard);
                });
                
                this.attachPoolEventListeners();
            }

            applyFilters(pools) {
                const riskFilter = document.getElementById('riskFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const minInvestment = parseInt(document.getElementById('minInvestmentFilter').value) || 0;
                const maxInvestment = parseInt(document.getElementById('maxInvestmentFilter').value) || 1000000;
                
                return pools.filter(pool => {
                    // Risk filter
                    if (riskFilter !== 'all') {
                        const riskInfo = this.getRiskLevel(pool.riskScore);
                        if (riskInfo.level !== riskFilter) return false;
                    }
                    
                    // Status filter
                    if (statusFilter !== 'all' && pool.status !== statusFilter) return false;
                    
                    // Investment range filter (using share price as proxy)
                    const totalShares = Math.floor(pool.totalInvoiceValue / 1000);
                    const sharePrice = Math.round(pool.totalInvoiceValue / totalShares);
                    if (sharePrice < minInvestment || sharePrice > maxInvestment) return false;
                    
                    return true;
                });
            }

            attachPoolEventListeners() {
                document.querySelectorAll('.view-invest-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const poolKey = e.target.getAttribute('data-pool-key');
                        this.showInvestmentModal(poolKey);
                    });
                });

                // Add AI analyst button listeners
                document.querySelectorAll('.ai-analyst-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const poolKey = e.target.getAttribute('data-pool-key');
                        this.analyzeWithAI(poolKey);
                    });
                });
            }

            async showInvestmentModal(poolKey) {
                const pool = this.businessPools.get(poolKey);
                if (!pool) return;

                // Guard: do not open modal if no shares or pool fully funded
                const noShares = !pool.availableShares || pool.availableShares <= 0;
                if (noShares || pool.status === 'fully_funded') {
                    this.showToast('This pool is fully funded or has no shares available', 'info');
                    return;
                }
                
                this.selectedPool = pool;
                
                // Update modal title
                document.getElementById('investmentModalTitle').textContent = `Invest in ${pool.businessName}`;

                
                // Populate business profile
                const businessProfile = document.getElementById('businessProfile');
                businessProfile.innerHTML = `
                    <div class="profile-detail">
                        <div class="profile-label">Pool Name</div>
                        <div class="profile-value">${pool.businessName}</div>
                    </div>
                    <div class="profile-detail">
                        <div class="profile-label">Company</div>
                        <div class="profile-value">${pool.companyName}</div>
                    </div>
                    <div class="profile-detail">
                        <div class="profile-label">Industry</div>
                        <div class="profile-value">${pool.sellerUser.industry || 'Not specified'}</div>
                    </div>
                    <div class="profile-detail">
                        <div class="profile-label">Business Type</div>
                        <div class="profile-value">${pool.sellerUser.businessType || 'Not specified'}</div>
                    </div>
                    <div class="profile-detail">
                        <div class="profile-label">Monthly Invoicing</div>
                        <div class="profile-value">AED ${(pool.sellerUser.monthlyInvoicing || 0).toLocaleString()}</div>
                    </div>
                    <div class="profile-detail">
                        <div class="profile-label">Verification Level</div>
                        <div class="profile-value">${pool.sellerUser.verificationLevel || 'Basic'}</div>
                    </div>
                    <div class="profile-detail">
                        <div class="profile-label">Years in Business</div>
                        <div class="profile-value">${pool.sellerUser.yearsInBusiness || 'Not specified'}</div>
                    </div>
                `;
                
                // Populate investment details
                const investmentDetails = document.getElementById('investmentDetails');
                // Use the precomputed, consistent sharePrice and totalShares stored earlier
                const sharePrice = pool.sharePrice || 1000;
                const expectedROI = pool.avgDiscountRate * 0.8; // Simplified calculation
                
                investmentDetails.innerHTML = `
                    <div class="investment-detail">
                        <div class="investment-value">AED ${sharePrice.toLocaleString()}</div>
                        <div class="investment-label">Share Price</div>
                    </div>
                    <div class="investment-detail">
                        <div class="investment-value">${expectedROI.toFixed(1)}%</div>
                        <div class="investment-label">Expected ROI</div>
                    </div>
                    <div class="investment-detail">
                        <div class="investment-value">${pool.avgRepaymentDays} days</div>
                        <div class="investment-label">Repayment Period</div>
                    </div>
                    <div class="investment-detail">
                        <div class="investment-value">${pool.availableShares}</div>
                        <div class="investment-label">Available Shares</div>
                    </div>
                `;
                
                // Populate invoice breakdown
                const invoiceTable = document.getElementById('invoiceBreakdown').querySelector('tbody');
                invoiceTable.innerHTML = '';
                
                pool.invoices.forEach(invoice => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invoice.id}</td>
                        <td>${invoice.buyerName || 'Unknown'}</td>
                        <td>AED ${invoice.amount.toLocaleString()}</td>
                        <td>${new Date(invoice.dueDate).toLocaleDateString()}</td>
                        <td>${invoice.status || 'Pending'}</td>
                    `;
                    invoiceTable.appendChild(row);
                });
                
                // Set up investment form
                document.getElementById('investmentAmount').value = sharePrice;
                document.getElementById('shareCount').value = 1;

                // Update investment form to calculate total automatically
                // Use stored sharePrice/availableShares to prevent inconsistency
                const shareCountInput = document.getElementById('shareCount');
                const investmentAmountInput = document.getElementById('investmentAmount');
                const onShareCountChange = (e) => {
                    const shares = Math.max(0, parseInt(e.target.value) || 0);
                    const sp = this.selectedPool.sharePrice || 1000;
                    const maxShares = this.selectedPool.availableShares || 0;
                    if (shares > maxShares) {
                        investmentAmountInput.value = sp * maxShares;
                        shareCountInput.value = maxShares;
                        this.showToast(`Maximum ${maxShares} shares available`, 'info');
                        return;
                    }
                    investmentAmountInput.value = sp * shares;
                };
                shareCountInput.removeEventListener('input', shareCountInput._handler || (()=>{}));
                shareCountInput._handler = onShareCountChange;
                shareCountInput.addEventListener('input', shareCountInput._handler);

                const onInvestmentAmountChange = (e) => {
                    const amount = Math.max(0, parseInt(e.target.value) || 0);
                    const sp = this.selectedPool.sharePrice || 1000;
                    const maxShares = this.selectedPool.availableShares || 0;
                    const maxInvestment = sp * maxShares;
                    if (amount > maxInvestment) {
                        investmentAmountInput.value = maxInvestment;
                        shareCountInput.value = maxShares;
                        this.showToast(`Maximum investment is AED ${maxInvestment.toLocaleString()}`, 'info');
                        return;
                    }
                    const calculatedShares = Math.floor(amount / sp);
                    shareCountInput.value = calculatedShares;
                };
                investmentAmountInput.removeEventListener('input', investmentAmountInput._handler || (()=>{}));
                investmentAmountInput._handler = onInvestmentAmountChange;
                investmentAmountInput.addEventListener('input', investmentAmountInput._handler);

                // Show modal
                document.getElementById('investmentModal').classList.add('active');
            }

            hideInvestmentModal() {
                document.getElementById('investmentModal').classList.remove('active');
                this.selectedPool = null;
            }

            async simulateInvestment() {
                if (!this.selectedPool) return;
                
                const amount = parseInt(document.getElementById('investmentAmount').value);
                const shares = parseInt(document.getElementById('shareCount').value);
                
                if (!amount || amount <= 0 || !shares || shares <= 0) {
                    this.showToast('Please enter valid investment details', 'error');
                    return;
                }
                
                // Check if user is investor
                const userSnapshot = await database.ref('users/' + this.currentUserUid).once('value');
                const userData = userSnapshot.val();
                
                if (!userData || userData.userType !== 'investor') {
                    this.showToast('Only investors can make investments', 'error');
                    return;
                }
                
                // Calculate share price properly
                // Use stored consistent sharePrice
                const sharePrice = this.selectedPool.sharePrice || 1000;
                const totalInvestment = sharePrice * shares;
                
                if (shares > this.selectedPool.availableShares) {
                    this.showToast(`Only ${this.selectedPool.availableShares} shares available`, 'error');
                    return;
                }
                
                try {
                    // Create investment record with proper investor info
                    const investmentId = `INV_${Date.now()}`;
                    const investmentData = {
                        investmentId: investmentId,
                        investorUid: this.currentUserUid,
                        investorName: userData.fullName,
                        investorEmail: userData.email,
                        sellerUid: this.selectedPool.sellerUid,
                        businessName: this.selectedPool.companyName,
                        poolName: this.selectedPool.businessName,
                        poolId: this.selectedPool.poolId,
                        amount: totalInvestment,
                        shares: shares,
                        sharePrice: sharePrice,
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        expectedROI: this.selectedPool.avgDiscountRate * 0.8,
                        repaymentDate: new Date(Date.now() + this.selectedPool.avgRepaymentDays * 24 * 60 * 60 * 1000).toISOString()
                    };
                    
                    // Save investment to Firebase
                    await database.ref(`investments/${investmentId}`).set(investmentData);
                    
                    // Update the specific pool in Firebase
                    const poolRef = database.ref(`pools/${this.selectedPool.poolId}`);
                    const poolSnapshot = await poolRef.once('value');
                    const poolData = poolSnapshot.val();
                    
                    if (poolData) {
                        // Calculate new values
                        const currentFundedAmount = poolData.fundedAmount || 0;
                        const currentAvailableShares = (typeof poolData.availableShares !== 'undefined') ? poolData.availableShares : this.selectedPool.availableShares;
                        
                        const newFundedAmount = currentFundedAmount + totalInvestment;
                        const newAvailableShares = Math.max(0, currentAvailableShares - shares);
                        
                        // Determine new status
                        let newStatus = poolData.status;
                        if (newAvailableShares <= 0) {
                            newStatus = 'fully_funded';
                        } else if (newAvailableShares < currentAvailableShares) {
                            newStatus = 'partially_funded';
                        }
                        
                        // Update the pool in Firebase
                        await poolRef.update({
                            fundedAmount: newFundedAmount,
                            availableShares: newAvailableShares,
                            status: newStatus
                        });
                        
                        // Update local pool data
                        this.selectedPool.availableShares = newAvailableShares;
                        this.selectedPool.fundedAmount = newFundedAmount;
                        this.selectedPool.status = newStatus;
                        
                        // Update our businessPools map
                        const poolKey = `${this.selectedPool.sellerUid}_${this.selectedPool.poolId}`;
                        this.businessPools.set(poolKey, this.selectedPool);
                    }
                    
                    // Create transaction record
                    const transactionId = `TX_${Date.now()}`;
                    const transactionData = {
                        txId: transactionId,
                        type: 'investment',
                        fromUid: this.currentUserUid,
                        fromName: userData.fullName,
                        toUid: this.selectedPool.sellerUid,
                        toName: this.selectedPool.businessName,
                        amount: totalInvestment,
                        shares: shares,
                        sharePrice: sharePrice,
                        relatedInvestment: investmentId,
                        relatedPool: this.selectedPool.poolId,
                        timestamp: Date.now(),
                        status: 'completed'
                    };
                    
                    await database.ref(`transactions/${transactionId}`).set(transactionData);
                    
                    // Update investor's portfolio
                    const investorPortfolioRef = database.ref(`investorPortfolios/${this.currentUserUid}/investments/${investmentId}`);
                    await investorPortfolioRef.set({
                        investmentId: investmentId,
                        businessName: this.selectedPool.businessName,
                        amount: totalInvestment,
                        shares: shares,
                        sharePrice: sharePrice,
                        purchaseDate: new Date().toISOString(),
                        status: 'active'
                    });
                    
                    this.showToast(`Successfully invested AED ${totalInvestment.toLocaleString()} in ${this.selectedPool.businessName} (${shares} shares)`);
                    this.hideInvestmentModal();
                    
                    // Reload marketplace to reflect changes
                    setTimeout(() => this.loadMarketplace(), 1000);
                    
                } catch (error) {
                    console.error('Error processing investment:', error);
                    this.showToast('Error processing investment: ' + error.message, 'error');
                }
            }

            setupRealtimeListeners() {
                // Listen for changes to invoices
                database.ref('invoices').on('value', (snapshot) => {
                    console.log('Invoices updated, reloading marketplace...');
                    this.loadMarketplace();
                });
                
                // Listen for changes to pools
                database.ref('pools').on('value', (snapshot) => {
                    console.log('Pools updated, reloading marketplace...');
                    this.loadMarketplace();
                });
                
                // Listen for changes to investments
                database.ref('investments').on('value', (snapshot) => {
                    console.log('Investments updated, reloading marketplace...');
                    this.loadMarketplace();
                });
                
                // Listen for changes to investments for current user
                if (this.currentUserUid) {
                    database.ref('investments').orderByChild('investorUid').equalTo(this.currentUserUid)
                        .on('value', (snapshot) => {
                            console.log('User investments updated');
                            // You can update user's investment portfolio here
                        });
                }
            }

            setupInvestmentListeners() {
                // Listen for new investments
                database.ref('investments').orderByChild('investorUid').equalTo(this.currentUserUid).on('value', (snapshot) => {
                    console.log('Investments updated');
                    // You can show user's portfolio here
                });
                
                // Listen for transaction updates
                database.ref('transactions').orderByChild('fromUid').equalTo(this.currentUserUid).on('value', (snapshot) => {
                    console.log('Transactions updated');
                });
            }

            initializeEventListeners() {
                // Filter event listeners
                document.getElementById('riskFilter').addEventListener('change', () => this.renderBusinessPools());
                document.getElementById('statusFilter').addEventListener('change', () => this.renderBusinessPools());
                document.getElementById('minInvestmentFilter').addEventListener('input', () => this.renderBusinessPools());
                document.getElementById('maxInvestmentFilter').addEventListener('input', () => this.renderBusinessPools());
                
                // Modal event listeners
                document.getElementById('closeInvestmentModal').addEventListener('click', () => this.hideInvestmentModal());
                document.getElementById('cancelInvestment').addEventListener('click', () => this.hideInvestmentModal());
                document.getElementById('confirmInvestment').addEventListener('click', () => this.simulateInvestment());
                
                // Logout button
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    auth.signOut().then(() => {
                        localStorage.removeItem('currentUser');
                        window.location.href = 'index.html';
                    });
                });
                
                // Close modal when clicking outside
                document.getElementById('investmentModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('investmentModal')) {
                        this.hideInvestmentModal();
                    }
                });

                // AI Analysis modal event listeners
                document.getElementById('closeAiAnalysisModal').addEventListener('click', () => this.hideAiAnalysisModal());
                document.getElementById('closeAiAnalysisBtn').addEventListener('click', () => this.hideAiAnalysisModal());
                document.getElementById('aiAnalysisModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('aiAnalysisModal')) {
                        this.hideAiAnalysisModal();
                    }
                });
            }

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast';
                toast.classList.add(type === 'error' ? 'error' : 'success');
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }

        // Initialize the marketplace when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.marketplace = new InvoiceMarketplace();
            
            // Initialize chatbot after a short delay to ensure marketplace is loaded
            setTimeout(() => {
                window.investmentChatbot = new InvestmentChatbot();
            }, 1000);
        });
    </script>
<script>
    // Marketplace Authentication Check
    auth.onAuthStateChanged((user) => {
        if (!user) {
            alert('Please login first');
            window.location.href = 'index.html';
            return;
        }
        
        // Marketplace is accessible to both business and investor users
        console.log('User authenticated for marketplace:', user.uid);
    });

    // Update dashboard button based on user type
    auth.onAuthStateChanged((user) => {
        if (user) {
            database.ref('users/' + user.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    const dashboardBtn = document.querySelector('.auth-buttons .login-btn[onclick*="dashboard"]');
                    if (dashboardBtn && userData) {
                        if (userData.userType === 'business') {
                            dashboardBtn.setAttribute('onclick', "window.location.href='business_dashboard.html'");
                        } else if (userData.userType === 'investor') {
                            dashboardBtn.setAttribute('onclick', "window.location.href='investor_dashboard.html'");
                        }
                    }
                });
        }
    });


    // Marketplace navigation setup
    document.addEventListener('DOMContentLoaded', function() {
        const dashboardBtn = document.getElementById('dashboardBtn');
        if (dashboardBtn) {
            dashboardBtn.addEventListener('click', function() {
                const user = auth.currentUser;
                if (user) {
                    database.ref('users/' + user.uid).once('value')
                        .then((snapshot) => {
                            const userData = snapshot.val();
                            if (userData && userData.userType === 'business') {
                                window.location.href = 'business_dashboard.html';
                            } else if (userData && userData.userType === 'investor') {
                                window.location.href = 'investor_dashboard.html';
                            }
                        });
                }
            });
        }
    });
</script>

<!-- Fixed Investment Chatbot Widget -->
<div class="chatbot-widget" id="investmentChatbot">
    <div class="chatbot-header">
        <div class="chatbot-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="chatbot-info">
            <h4>InvoiceX AI Analyst</h4>
            <span class="status-online">Online</span>
        </div>
        <button class="close-modal" id="closeChatbot" style="background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
    
    <div class="chatbot-messages" id="chatbotMessages">
        <!-- Messages will be added here dynamically -->
    </div>
    
    <div class="chatbot-input">
        <input type="text" id="chatbotInput" placeholder="Ask about investment opportunities...">
        <button id="sendMessage" class="send-btn">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<button class="chatbot-toggle" id="toggleChatbot">
    <i class="fas fa-robot"></i>
    <span class="chatbot-notification" id="chatbotNotification" style="display: none;">1</span>
</button>
</body>
</html>
